syntax = "proto3";

package cash.z.wallet.sdk.rpc;

option go_package = "github.com/zcash/lightwalletd/walletrpc";

// Import compact block format definitions
// Note: Both files are in the same directory, so we can import directly
import "compact_formats.proto";

// Service for streaming compact transaction data
service CompactTxStreamer {
  // Get the latest block height and other info
  rpc GetLightdInfo(Empty) returns (LightdInfo);

  // Get a range of compact blocks
  rpc GetBlockRange(BlockRange) returns (stream CompactBlock);

  // Get the latest block
  rpc GetLatestBlock(ChainSpec) returns (CompactBlock);

  // Get the tree state at a specific block height
  // Required for wallet initialization to seed Sapling/Orchard note commitment trees
  rpc GetTreeState(BlockID) returns (TreeState);

  // Return the requested full (not compact) transaction (as from zcashd)
  // This includes the full encrypted memo data needed to decrypt messages
  rpc GetTransaction(TxFilter) returns (RawTransaction);
}

// A TxFilter contains the information needed to identify a particular
// transaction: either a block and an index, or a direct transaction hash.
// Currently, only specification by hash is supported.
message TxFilter {
  BlockID block = 1;     // block identifier, height or hash
  uint64 index = 2;      // index within the block
  bytes hash = 3;        // transaction ID (hash, txid)
}

// RawTransaction contains the complete transaction data including encrypted memos.
message RawTransaction {
  // The serialized representation of the Zcash transaction.
  bytes data = 1;
  // The height at which the transaction is mined.
  // 0 = mempool, 0xffffffffffffffff = mined on non-main fork
  uint64 height = 2;
}

message Empty {}

message LightdInfo {
  string version = 1;
  string vendor = 2;
  bool taddr_support = 3;
  string chain_name = 4;
  uint64 sapling_activation_height = 5;
  string consensus_branch_id = 6;
  uint64 block_height = 7;
  uint64 estimated_height = 8;
  string zcashd_build = 9;
  string zcashd_subversion = 10;
}

// TreeState contains the Sapling and Orchard note commitment tree states
// at a specific block height. Used to initialize wallet sync state.
message TreeState {
  string network = 1;           // "main" or "test"
  uint64 height = 2;            // block height
  string hash = 3;              // block hash as hex string
  uint32 time = 4;              // block time
  string saplingTree = 5;       // hex-encoded Sapling commitment tree frontier
  string orchardTree = 6;       // hex-encoded Orchard commitment tree frontier
}

message ChainSpec {
  string chain_name = 1;
}

message BlockID {
  uint64 height = 1;
  bytes hash = 2;
}

message BlockRange {
  BlockID start = 1;
  BlockID end = 2;
}
